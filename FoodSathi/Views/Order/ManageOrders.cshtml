@model IEnumerable<FoodSathi.Models.Order>
@{
    ViewData["Title"] = "Manage Orders | FoodSathi";
}

<div class="container-fluid py-5 fade-in">

    <!-- 🌟 Header Section -->
    <div class="text-center mb-5">
        <h1 class="fw-bold text-gradient mb-2">📦 Manage Orders</h1>
        <p class="text-muted">Track, update, and manage all customer orders in one place</p>
    </div>

    <!-- 🧭 Filter Toolbar -->
    <div class="toolbar d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4 p-3 rounded-4 shadow-sm bg-white bg-opacity-75 backdrop-blur">
        <div class="filter-group d-flex flex-wrap gap-2 align-items-center w-100 w-md-auto">
            <div class="input-group input-group-sm shadow-sm flex-grow-1 flex-md-grow-0">
                <span class="input-group-text bg-light"><i class="bi bi-person-search"></i></span>
                <input type="text" id="searchUser" class="form-control border-0" placeholder="Search by user name">
            </div>

            <select id="filterPayment" class="form-select form-select-sm shadow-sm">
                <option value="">Payment Status</option>
                <option value="Pending">Pending</option>
                <option value="Paid">Paid</option>
            </select>

            <select id="filterDelivery" class="form-select form-select-sm shadow-sm">
                <option value="">Delivery Status</option>
                <option value="Order Placed">Order Placed</option>
                <option value="Preparing">Preparing</option>
                <option value="Out for Delivery">Out for Delivery</option>
                <option value="Delivered">Delivered</option>
                <option value="Ready for Pickup">Ready for Pickup</option>
                <option value="Picked Up">Picked Up</option>
                <option value="Cancelled">Cancelled</option>
            </select>

            <input type="date" id="filterDate" class="form-control form-control-sm shadow-sm">
        </div>

        <div class="d-flex gap-2 justify-content-end flex-wrap w-100 w-md-auto">
            <button id="refreshBtn" class="btn btn-outline-primary shadow-sm w-100 w-md-auto">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button id="updateAllBtn" class="btn btn-primary shadow-sm w-100 w-md-auto">
                <i class="bi bi-save2"></i> Update All
            </button>
        </div>
    </div>

    <!-- 💼 Orders Table (Desktop View) -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden d-none d-md-block">
        <div class="card-header text-white fw-semibold py-3 bg-gradient-primary">
            <i class="bi bi-list-check"></i> Orders Overview
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="ordersTable" class="table align-middle mb-0 table-hover">
                    <thead class="table-dark text-uppercase">
                        <tr>
                            <th>#</th>
                            <th>User</th>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Total</th>
                            <th>Payment</th>
                            <th>Delivery</th>
                            <th>Order Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in Model)
                        {
                            <tr data-id="@order.OrderID"
                                data-user="@order.UserName"
                                data-payment="@order.PaymentStatus"
                                data-delivery="@order.DeliveryStatus"
                                data-date="@order.OrderDate.ToString("yyyy-MM-dd")">

                                <td class="fw-semibold text-primary">#@order.OrderID</td>
                                <td>@order.UserName</td>
                                <td>@order.ItemName</td>
                                <td>@order.Quantity</td>
                                <td class="fw-bold text-success">Rs. @order.TotalPrice</td>

                                <td>
                                    <select class="form-select form-select-sm payment-status">
                                        <option value="Pending" selected="@(order.PaymentStatus == "Pending")">Pending</option>
                                        <option value="Paid" selected="@(order.PaymentStatus == "Paid")">Paid</option>
                                    </select>
                                </td>

                                <td>
                                    <select class="form-select form-select-sm delivery-status">
                                        <option value="Order Placed" selected="@(order.DeliveryStatus == "Order Placed")">Order Placed</option>
                                        <option value="Preparing" selected="@(order.DeliveryStatus == "Preparing")">Preparing</option>
                                        <option value="Out for Delivery" selected="@(order.DeliveryStatus == "Out for Delivery")">Out for Delivery</option>
                                        <option value="Delivered" selected="@(order.DeliveryStatus == "Delivered")">Delivered</option>
                                        <option value="Ready for Pickup" selected="@(order.DeliveryStatus == "Ready for Pickup")">Ready for Pickup</option>
                                        <option value="Picked Up" selected="@(order.DeliveryStatus == "Picked Up")">Picked Up</option>
                                        <option value="Cancelled" selected="@(order.DeliveryStatus == "Cancelled")">Cancelled</option>
                                    </select>
                                </td>

                                <td>
                                    @order.OrderDate.ToString("MMM dd, yyyy - hh:mm tt")
                                    <button class="btn btn-sm btn-outline-primary ms-2 view-details-btn"
                                            data-id="@order.OrderID">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 📱 Mobile Collapsible View -->
    <div class="d-md-none">
        @foreach (var order in Model)
        {
            <div class="order-card border rounded-4 shadow-sm mb-3 p-3 bg-white bg-opacity-75" data-id="@order.OrderID">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="fw-bold text-primary mb-0">#@order.OrderID - @order.UserName</h6>
                        <small class="text-muted">@order.OrderDate.ToString("MMM dd, yyyy - hh:mm tt")</small>
                    </div>
                    <button class="btn btn-sm btn-light toggle-details rounded-circle">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>

                <div class="details mt-3" style="display: none;">
                    <hr class="my-2">
                    <p class="mb-1"><strong>Item:</strong> @order.ItemName</p>
                    <p class="mb-1"><strong>Quantity:</strong> @order.Quantity</p>
                    <p class="mb-1 text-success"><strong>Total:</strong> Rs. @order.TotalPrice</p>

                    <div class="mb-2">
                        <label class="form-label small fw-semibold mb-1">Payment:</label>
                        <select class="form-select form-select-sm payment-status">
                            <option value="Pending" selected="@(order.PaymentStatus == "Pending")">Pending</option>
                            <option value="Paid" selected="@(order.PaymentStatus == "Paid")">Paid</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-semibold mb-1">Delivery:</label>
                        <select class="form-select form-select-sm delivery-status">
                            <option value="Order Placed" selected="@(order.DeliveryStatus == "Order Placed")">Order Placed</option>
                            <option value="Preparing" selected="@(order.DeliveryStatus == "Preparing")">Preparing</option>
                            <option value="Out for Delivery" selected="@(order.DeliveryStatus == "Out for Delivery")">Out for Delivery</option>
                            <option value="Delivered" selected="@(order.DeliveryStatus == "Delivered")">Delivered</option>
                            <option value="Ready for Pickup" selected="@(order.DeliveryStatus == "Ready for Pickup")">Ready for Pickup</option>
                            <option value="Picked Up" selected="@(order.DeliveryStatus == "Picked Up")">Picked Up</option>
                            <option value="Cancelled" selected="@(order.DeliveryStatus == "Cancelled")">Cancelled</option>
                        </select>
                    </div>

                    <button class="btn btn-sm btn-outline-primary w-100 mt-2 view-details-btn" data-id="@order.OrderID">
                        <i class="bi bi-eye"></i> View Full Details
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- 🔍 Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title fw-semibold">
                        <i class="bi bi-receipt-cutoff"></i> Order Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="orderDetailsContent" class="fade-in">
                        <div class="text-center text-muted">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .text-gradient {
            background: linear-gradient(90deg, #0062ff, #00bcd4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .bg-gradient-primary {
            background: linear-gradient(90deg, #0062ff, #00bcd4);
        }

        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.07);
            transform: scale(1.005);
        }

        .order-card {
            transition: all 0.3s ease;
        }

            .order-card.open {
                border-color: #00bcd4;
                box-shadow: 0 0 10px rgba(0, 188, 212, 0.3);
            }

        .toggle-details {
            transition: transform 0.3s ease;
        }

            .toggle-details.open i {
                transform: rotate(180deg);
            }

        .detail-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .status-badge-large {
            font-size: 1rem;
            padding: 8px 16px;
        }

        @@media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
            }

                .toolbar .filter-group {
                    width: 100%;
                    flex-direction: column;
                }

                .toolbar .btn {
                    width: 100%;
                }
        }
    </style>
}

@section Scripts {
    <script>
        // Helper function to get correct image URL
        function getImageUrl(imagePath) {
            console.log('Processing image path:', imagePath);

            if (!imagePath || imagePath === 'null' || imagePath === 'undefined' || imagePath.trim() === '') {
                console.log('No valid image path, using fallback');
                return '/images/no-image.png';
            }

            // If it already starts with http or /, return as is
            if (imagePath.startsWith('http') || imagePath.startsWith('/')) {
                return imagePath;
            }

            // Otherwise add / at the beginning
            return '/' + imagePath;
        }

        // Setup listeners
        function setupStatusDropdowns() {
            document.querySelectorAll('.payment-status, .delivery-status').forEach(select => {
                select.addEventListener('change', e => {
                    const row = e.target.closest('[data-id]');
                    row.dataset.updated = true;
                });
            });
        }
        setupStatusDropdowns();

        // Refresh
        document.getElementById('refreshBtn').addEventListener('click', () => location.reload());

        // Update All
        document.getElementById('updateAllBtn').addEventListener('click', async () => {
            const updated = document.querySelectorAll('[data-id][data-updated="true"]');
            if (!updated.length) return alert("No changes to update.");

            for (const el of updated) {
                const id = el.dataset.id;
                const pay = el.querySelector('.payment-status').value;
                const del = el.querySelector('.delivery-status').value;

                await Promise.all([
                    fetch(`/Order/UpdatePayment?id=${id}&paymentStatus=${pay}`, { method: 'POST' }),
                    fetch(`/Order/UpdateDeliveryStatus?id=${id}&status=${del}`, { method: 'POST' })
                ]);

                el.dataset.updated = false;
                el.classList.add('open');
                setTimeout(() => el.classList.remove('open'), 1200);
            }

            alert("✅ Orders updated successfully!");
        });

        // Filters
        ['searchUser', 'filterPayment', 'filterDelivery', 'filterDate'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', filterOrders);
        });

        function filterOrders() {
            const search = document.getElementById('searchUser').value.toLowerCase();
            const pay = document.getElementById('filterPayment').value;
            const del = document.getElementById('filterDelivery').value;
            const date = document.getElementById('filterDate').value;

            document.querySelectorAll('[data-id]').forEach(row => {
                const user = row.dataset.user?.toLowerCase() || '';
                const payment = row.dataset.payment;
                const delivery = row.dataset.delivery;
                const orderDate = row.dataset.date;
                let show = true;

                if (search && !user.includes(search)) show = false;
                if (pay && payment !== pay) show = false;
                if (del && delivery !== del) show = false;
                if (date && orderDate !== date) show = false;

                row.style.display = show ? '' : 'none';
            });
        }

        // Toggle collapsible cards on mobile
        document.querySelectorAll('.toggle-details').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.order-card');
                const details = card.querySelector('.details');
                const open = details.style.display === 'block';
                details.style.display = open ? 'none' : 'block';
                card.classList.toggle('open', !open);
                btn.classList.toggle('open', !open);
            });
        });

        // 🧾 View Details Modal - WITH IMAGE
        document.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.dataset.id;
                const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                const content = document.getElementById('orderDetailsContent');

                content.innerHTML = '<div class="text-center text-muted"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                try {
                    const res = await fetch(`/Order/GetOrderDetails?id=${id}`);
                    if (!res.ok) throw new Error('Failed to fetch order details');

                    const data = await res.json();
                    console.log('Full Order Details Response:', data);
                    console.log('ItemImage value:', data.itemImage);

                    // Get image URL - MATCH YOUR BACKEND EXACTLY (itemImage with lowercase 'i')
                    const imageUrl = getImageUrl(data.itemImage);
                    console.log('Final image URL:', imageUrl);

                 // Fallback values
                    const itemName = data.itemName || data.ItemName || 'N/A';
                    const userName = data.userName || data.UserName || 'N/A';
                    const quantity = data.quantity || data.Quantity || 'N/A';
                    const totalPrice = data.totalPrice || data.TotalPrice || 0;
                    const paymentMethod = data.paymentMethod || data.PaymentMethod || 'N/A';
                    const paymentStatus = data.paymentStatus || data.PaymentStatus || 'N/A';
                    const deliveryStatus = data.deliveryStatus || data.DeliveryStatus || 'N/A';
                    const deliveryOption = data.deliveryOption || data.DeliveryOption || 'N/A';
                    const deliveryAddress = data.deliveryAddress || data.DeliveryAddress || data.address || data.Address || 'Not provided';
                    const orderDate = data.orderDate || data.OrderDate || 'N/A';

                    // Status badge colors
                    const deliveryBadgeClass = ['Delivered','Picked Up'].includes(deliveryStatus) ? 'bg-success' :
                                               deliveryStatus === 'Cancelled' ? 'bg-danger' : 'bg-warning text-dark';
                    const paymentBadgeClass = paymentStatus === 'Paid' ? 'bg-success' : 'bg-warning text-dark';

                    // Render modal content (cart-style)
                    content.innerHTML = `
                        <div class="row g-4 align-items-center">
                            <!-- 🖼️ Food Image -->
                            <div class="col-4">
                                <img src="${imageUrl}"
                                     alt="${itemName}"
                                     class="img-fluid rounded-start shadow-sm border"
                                     style="object-fit: cover; width: 100%; height: 220px;"
                                     onerror="console.error('Image load failed:', this.src); this.src='/images/no-image.png';" />
                            </div>

                            <!-- 📋 Order Info -->
                            <div class="col-8">
                                <h4 class="fw-bold text-primary mb-3">
                                    <i class="bi bi-cart-check-fill"></i> ${itemName}
                                </h4>

                                <div class="detail-card">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1"><i class="bi bi-person-circle"></i> Customer</small>
                                            <strong>${userName}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1"><i class="bi bi-box-seam"></i> Quantity</small>
                                            <strong>${quantity}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1"><i class="bi bi-cash-coin"></i> Total Price</small>
                                            <strong class="text-success fs-5">₹${totalPrice}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block mb-1"><i class="bi bi-credit-card-2-front"></i> Payment Method</small>
                                            <strong>${paymentMethod}</strong>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-check2-square"></i> Payment Status</small>
                                    <span class="badge ${paymentBadgeClass} status-badge-large">${paymentStatus}</span>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-truck"></i> Delivery Status</small>
                                    <span class="badge ${deliveryBadgeClass} status-badge-large">${deliveryStatus}</span>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-geo-alt-fill"></i> Delivery Option</small>
                                    <strong>${deliveryOption}</strong>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-house-door-fill"></i> Delivery Address</small>
                                    <strong>${deliveryAddress}</strong>
                                </div>

                                <div class="mb-0 mt-4 pt-3 border-top">
                                    <small class="text-muted d-block mb-1"><i class="bi bi-calendar-event"></i> Order Date</small>
                                    <span class="text-secondary fw-semibold">${orderDate}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading order details:', error);
                    content.innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                            <p class="text-danger mt-3 fw-semibold">Failed to load order details.</p>
                            <p class="text-muted small">Error: ${error.message}</p>
                            <p class="text-muted small">Please try again or contact support.</p>
                        </div>
                    `;
                }

                modal.show();
            });
        });
    </script>
}