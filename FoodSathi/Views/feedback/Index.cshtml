@model IEnumerable<FoodSathi.Models.Feedback>
@{
    ViewData["Title"] = "Customer Feedback";
}

<div class="container py-5 fade-in">

    <div class="text-center mb-5 position-relative">
        <div class="logo-circle mx-auto d-flex align-items-center justify-content-center shadow-glow mb-3"
             style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,#6bc5ff,#00ff9d);">
            <i class="bi bi-basket2-heart-fill fs-1 text-light"></i>
        </div>
        <h1 class="fw-bold brand-name text-gradient mb-2"
            style="background: linear-gradient(45deg,#ff9a9e,#fad0c4); -webkit-background-clip: text; color: transparent;">
            FoodSathi
        </h1>
        <h4 class="fw-semibold text-success">We Value Your Feedback 💚</h4>
        <p class="text-muted mt-2 fs-6">
            Your insights help us make <span class="fw-semibold text-success">FoodSathi</span> even better 🌿
        </p>
    </div>
    <div class="card border-0 glass-card shadow-xl rounded-5 p-5 mb-5 mx-auto"
         style="max-width:720px; backdrop-filter: blur(15px); background: rgba(255,255,255,0.05);">
        <form id="feedbackForm" method="post" asp-controller="Feedback" asp-action="SubmitFeedback">
            @Html.AntiForgeryToken()
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Your Name / Email</label>
                    <input type="text" name="Name" class="form-control form-control-lg rounded-4 shadow-sm"
                           placeholder="John Doe"
                           value="@ViewBag.UserName"
                           @(User.Identity.IsAuthenticated ? "readonly" : "required") />
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Product Name</label>
                    <input type="text" name="ProductName" class="form-control form-control-lg rounded-4 shadow-sm"
                           placeholder="E.g., Paneer Momo" required />
                </div>
            </div>

            <div class="my-4 text-center">
                <label class="form-label fw-semibold d-block mb-2">Your Rating</label>
                <div id="starRating" class="fs-1 text-warning d-flex justify-content-center gap-3 cursor-pointer">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <i class="bi bi-star" data-value="@i"></i>
                    }
                </div>
                <input type="hidden" name="Rating" id="ratingValue" />
            </div>

            <div class="mb-4">
                <label class="form-label fw-semibold">Your Review</label>
                <textarea name="Message" class="form-control rounded-4 shadow-sm" rows="4"
                          placeholder="Share your experience..." required></textarea>
            </div>

            <div class="text-center">
                <button type="submit"
                        class="btn btn-gradient btn-lg px-5 py-2 rounded-pill shadow-hover"
                        style="background: linear-gradient(90deg, #00ff9d, #6bc5ff); color:white;">
                    <i class="bi bi-send-fill me-2"></i>Submit Feedback
                </button>
            </div>
        </form>
    </div>
    @if (Model.Any())
    {
        <div class="text-center mb-5 fade-in">
            <div class="card glass-card border-0 rounded-5 shadow-lg p-4 mx-auto"
                 style="max-width:420px; backdrop-filter: blur(15px); background: rgba(255,255,255,0.05);">
                <h5 class="fw-bold text-success mb-3">⭐ Average Rating</h5>
                @{
                    double avg = Convert.ToDouble(ViewBag.AvgRating);
                    int fullStars = (int)Math.Floor(avg);
                }
                <div class="fs-3 text-warning mb-2">
                    @for (int i = 0; i < fullStars; i++)
                    {
                        <i class="bi bi-star-fill"></i>
                    }
                    @if (avg - fullStars >= 0.5)
                    {
                        <i class="bi bi-star-half"></i>
                    }
                </div>
                <h3 class="fw-bold mb-1 text-dark">@avg.ToString("0.0") / 5</h3>
                <p class="text-muted mb-0 small">Based on @Model.Count() verified reviews</p>
            </div>
        </div>
    }

    <h4 class="fw-bold text-success text-center mb-4">Recent Feedback 💬</h4>
    <div class="row g-4 justify-content-center">
        @foreach (var f in Model)
        {
            <div class="col-sm-12 col-md-6 col-lg-4">
                <div class="card border-0 glass-card rounded-4 p-4 h-100 hover-card shadow-hover"
                     style="transition: transform 0.3s, box-shadow 0.3s;">
                    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                        <h5 class="text-success fw-semibold mb-0 text-truncate">@f.ProductName</h5>
                        <small class="text-muted">@f.SubmittedDate.ToString("MMM dd, yyyy")</small>
                    </div>
                    <div class="text-warning mb-2 fs-5">
                        @for (int i = 0; i < f.Rating; i++)
                        {
                            <i class="bi bi-star-fill"></i>
                        }
                    </div>
                    <p class="text-muted mb-3">"@f.Message"</p>
                    <small class="text-secondary">– @f.Name</small>
                </div>
            </div>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const stars = document.querySelectorAll("#starRating i");
    const ratingValue = document.getElementById("ratingValue");
    stars.forEach(star => {
        star.addEventListener("click", () => {
            const value = star.getAttribute("data-value");
            ratingValue.value = value;
            stars.forEach(s => s.classList.replace("bi-star-fill", "bi-star"));
            for (let i = 0; i < value; i++) stars[i].classList.replace("bi-star", "bi-star-fill");
        });
    });

    @if (ViewBag.Success != null)
    {
            <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: '@ViewBag.Success',
                    showConfirmButton: false,
                    timer: 2000,
                    toast: true,
                    position: 'top-end'
                });
            </text>
    }
</script>
