@model FoodSathi.Models.Order

@{
    ViewData["Title"] = "Payment";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8 col-sm-10">

            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-4">

                    <h2 class="text-center text-primary fw-bold mb-4">
                        💳 Choose Payment Method
                    </h2>
                    <hr />

                    <!-- Order Summary -->
                    <div class="mb-3 text-center">
                        <p class="fs-5 mb-1"><strong>Item:</strong> @Model.ItemName</p>
                        <p class="fs-5 mb-1">
                            <strong>Total Amount:</strong>
                            <span class="text-success fw-bold">Rs. @Model.TotalPrice</span>
                        </p>
                    </div>

                    <form asp-action="ConfirmPayment" method="post" enctype="multipart/form-data" id="paymentForm">
                        <input type="hidden" name="orderId" value="@Model.OrderID" />

                        <!-- Payment Options -->
                        <div class="payment-options">
                            <!-- eSewa -->
                            <label class="payment-card">
                                <input type="radio" name="method" value="Esewa" required />
                                <div class="card-body d-flex align-items-center">
                                    <img src="https://esewa.com.np/common/images/esewa-icon-large.png"
                                         alt="eSewa" width="40" class="me-3" />
                                    <div>
                                        <h6 class="mb-1 fw-bold">eSewa</h6>
                                        <small class="text-muted">Instant mobile wallet payment</small>
                                    </div>
                                </div>
                            </label>

                            <!-- Khalti -->
                            <label class="payment-card">
                                <input type="radio" name="method" value="Khalti" required />
                                <div class="card-body d-flex align-items-center">
                                    <img src="https://seeklogo.com/images/K/khalti-logo-97E8E2E74A-seeklogo.com.png"
                                         alt="Khalti" width="40" class="me-3" />
                                    <div>
                                        <h6 class="mb-1 fw-bold">Khalti</h6>
                                        <small class="text-muted">Fast & secure digital payment</small>
                                    </div>
                                </div>
                            </label>

                            <!-- Bank Transfer -->
                            <label class="payment-card">
                                <input type="radio" name="method" value="Bank" required />
                                <div class="card-body d-flex align-items-center">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2331/2331948.png"
                                         alt="Bank" width="40" class="me-3" />
                                    <div>
                                        <h6 class="mb-1 fw-bold">Bank Transfer</h6>
                                        <small class="text-muted">Pay via your bank account</small>
                                    </div>
                                </div>
                            </label>

                            <!-- Cash on Delivery -->
                            <label class="payment-card">
                                <input type="radio" name="method" value="CashOnDelivery" required />
                                <div class="card-body d-flex align-items-center">
                                    <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png"
                                         alt="COD" width="40" class="me-3" />
                                    <div>
                                        <h6 class="mb-1 fw-bold">Cash on Delivery</h6>
                                        <small class="text-muted">Pay when your food arrives</small>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Bank Transfer Section -->
                        <div id="bankOptions" class="mt-3 p-3 border rounded bg-light d-none fade-section">
                            <label class="fw-bold mb-2">🏦 Select Your Bank:</label>
                            <select class="form-select mb-3" id="bankSelect" name="bankName" required>
                                <option value="">-- Choose Bank --</option>
                                <option value="Kumari Bank">Kumari Bank</option>
                                <option value="Machhapuchchhre Bank">Machhapuchchhre Bank</option>
                                <option value="Nabil Bank">Nabil Bank</option>
                                <option value="NIC Asia Bank">NIC Asia Bank</option>
                                <option value="Prabhu Bank">Prabhu Bank</option>
                            </select>

                            <div id="branchSection" class="d-none fade-section">
                                <label class="fw-bold mb-2">🏢 Select Branch:</label>
                                <select class="form-select mb-3" id="branchSelect" name="branchName" required>
                                    <option value="">-- Choose Branch --</option>
                                </select>
                            </div>

                            <!-- User Account -->
                            <div id="userAccountSection" class="d-none fade-section">
                                <label class="fw-bold mb-2">🧍‍♂️ Your Account Details:</label>
                                <input type="text" class="form-control mb-2" name="accountName" placeholder="Account holder name" required />
                                <input type="text" class="form-control mb-3" name="accountNumber" id="accountNumber"
                                       placeholder="Enter your account number" required />
                                <small id="accError" class="text-danger d-none">❌ Invalid account number (10–16 digits required)</small>
                            </div>

                            <!-- FoodSathi Account -->
                            <div id="bankDetails" class="p-3 rounded bg-white shadow-sm d-none fade-section">
                                <p class="mb-1"><strong>Pay To:</strong> FoodSathi Pvt. Ltd.</p>
                                <p class="mb-1"><strong>Account Number:</strong> <span id="accNumber"></span></p>
                                <p class="mb-1"><strong>Branch:</strong> <span id="branchName"></span></p>
                            </div>

                            <!-- Upload Screenshot -->
                            <div id="uploadSlip" class="mt-3 d-none fade-section">
                                <label class="fw-bold">📸 Upload Payment Slip / Screenshot:</label>
                                <input type="file" name="PaymentSlip" class="form-control mt-2" accept="image/*" required />
                                <small class="text-muted">Upload your transaction screenshot for verification</small>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between mt-4 flex-wrap gap-2">
                            <a asp-controller="Order"
                               asp-action="Checkout"
                               asp-route-orderName="@Model.ItemName"
                               class="btn btn-outline-secondary flex-grow-1">
                                🔙 Back
                            </a>
                            <button type="submit" class="btn btn-success flex-grow-1">
                                ✅ Confirm Payment
                            </button>
                        </div>
                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">📲 Scan & Pay</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-2">Use your wallet app to scan this QR</p>
                <img id="qrImage" src="" alt="QR Code" class="img-fluid rounded-3 shadow" style="max-width:250px;" />
                <p class="text-muted mt-3"><small>Make sure to confirm your payment after scanning</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">
                    ✅ Done, Continue
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSS -->
<style>
    .payment-card {
        display: block;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
    }

        .payment-card input {
            display: none;
        }

        .payment-card:hover {
            border-color: #0d6efd;
            transform: scale(1.02);
        }

        .payment-card input:checked + .card-body {
            border-color: #0d6efd;
            background: #f0f8ff;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(13,110,253,0.2);
        }

    .fade-section {
        transition: all 0.4s ease-in-out;
    }

        .fade-section.d-none {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        .fade-section:not(.d-none) {
            opacity: 1;
            max-height: 800px;
        }

    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
    }
    @@media (max-width: 768px) {
        .card-body

    {
        padding: 1.2rem;
    }

    .payment-card .card-body img {
        width: 32px;
    }

    }
</style>

<!-- Script -->
<script>
    const bankInfo = {
        "Kumari Bank": { acc: "1234567890", branches: ["New Road", "Bagar", "Chipledhunga"] },
        "Machhapuchchhre Bank": { acc: "9876543210", branches: ["Lakeside", "Mahendrapool", "Amarsingh"] },
        "Nabil Bank": { acc: "1122334455", branches: ["Chipledhunga", "Lakeside", "Bagar"] },
        "NIC Asia Bank": { acc: "5566778899", branches: ["Bagar", "Mahendrapool", "New Road"] },
        "Prabhu Bank": { acc: "2233445566", branches: ["Mahendrapool", "Lakeside", "Chipledhunga"] }
    };

    // Show/Hide Bank Section
    document.querySelectorAll("input[name='method']").forEach(radio => {
        radio.addEventListener("change", function () {
            const bankOptions = document.getElementById("bankOptions");
            if (this.value === "Bank") bankOptions.classList.remove("d-none");
            else bankOptions.classList.add("d-none");
        });
    });

    // Bank selection logic
    document.getElementById("bankSelect").addEventListener("change", function () {
        const branchSelect = document.getElementById("branchSelect");
        const branchSection = document.getElementById("branchSection");
        branchSelect.innerHTML = '<option value="">-- Choose Branch --</option>';

        const selectedBank = this.value;
        if (selectedBank && bankInfo[selectedBank]) {
            bankInfo[selectedBank].branches.forEach(branch => {
                const opt = document.createElement("option");
                opt.value = branch;
                opt.textContent = "🏢 " + branch;
                branchSelect.appendChild(opt);
            });
            branchSection.classList.remove("d-none");
        } else {
            branchSection.classList.add("d-none");
        }
    });

    // Branch selected logic
    document.getElementById("branchSelect").addEventListener("change", function () {
        const selectedBank = document.getElementById("bankSelect").value;
        const selectedBranch = this.value;
        if (selectedBranch && bankInfo[selectedBank]) {
            document.getElementById("accNumber").innerText = bankInfo[selectedBank].acc;
            document.getElementById("branchName").innerText = selectedBranch;
            ["bankDetails", "uploadSlip", "userAccountSection"].forEach(id => document.getElementById(id).classList.remove("d-none"));
        }
    });

    // Account validation
    const accInput = document.getElementById("accountNumber");
    const accError = document.getElementById("accError");
    accInput.addEventListener("input", () => {
        const valid = /^[0-9]{10,16}$/.test(accInput.value.trim());
        accInput.classList.toggle("is-invalid", !valid);
        accError.classList.toggle("d-none", valid);
    });

    // QR Modal for eSewa / Khalti
    document.getElementById("paymentForm").addEventListener("submit", function (e) {
        let method = document.querySelector("input[name='method']:checked")?.value;
        if (method === "Esewa" || method === "Khalti") {
            e.preventDefault();
            const qrImg = document.getElementById("qrImage");
            const base = method === "Esewa" ? "eSewaPayment" : "KhaltiPayment";
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${base}:Order-${@Model.OrderID}-Rs.${@Model.TotalPrice}`;
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        }
    });
</script>
