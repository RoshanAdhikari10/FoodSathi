@{
    ViewData["Title"] = "Wallet Payment | FoodSathi";
    var amount = ViewBag.Amount;
    var fromCart = ViewBag.FromCart ?? false;
    var orderId = ViewBag.OrderId;
}

<div class="wallet-payment-container d-flex justify-content-center align-items-center my-5">
    <div class="payment-card shadow-lg rounded-5 p-5 text-center">

        <h2 class="fw-bold text-gradient mb-2">💼 Wallet Payment</h2>
        <p class="text-muted mb-4">Fast • Secure • Seamless</p>

        <div class="summary-box mb-4 p-3 rounded-4">
            @if (fromCart)
            {
                <p class="fw-semibold mb-1 text-secondary">Payment for Cart Items</p>
            }
            else
            {
                <p class="fw-semibold mb-1 text-secondary">Order ID: <span class="text-gradient">#@orderId</span></p>
            }
            <p class="fw-semibold mb-0 text-success fs-5">Rs. @amount</p>
        </div>

        <form id="walletPaymentForm" asp-action="@((fromCart) ? "PayByWalletConfirmFromCart" : "PayByWalletConfirm")" method="post" class="text-start">
            @Html.AntiForgeryToken()

            @if (!fromCart)
            {
                <input type="hidden" name="orderId" value="@orderId" />
            }
            else
            {
                <input type="hidden" name="amount" value="@amount" />
            }

            <div class="mb-4">
                <label for="walletType" class="fw-semibold mb-2">Select Wallet</label>
                <select name="walletType" id="walletType" class="form-select shadow-sm rounded-pill py-2 text-center" required onchange="showWalletIdField()">
                    <option value="">-- Choose Wallet --</option>
                    <option value="eSewa">💚 eSewa</option>
                    <option value="Khalti">💜 Khalti</option>
                    <option value="IME Pay">🧡 IME Pay</option>
                </select>
            </div>

            <div class="mb-4" id="walletIdDiv" style="display:none;">
                <label for="walletId" id="walletIdLabel" class="fw-semibold mb-2">Wallet ID</label>
                <input type="text" name="walletId" id="walletId" class="form-control shadow-sm rounded-pill text-center py-2" placeholder="Enter Wallet ID" required />
            </div>

            <button type="button" class="btn btn-gradient w-100 rounded-pill fw-bold shadow py-2 fs-5" onclick="openPinModal()">
                💸 Confirm Wallet Payment
            </button>
        </form>

        <div class="mt-4">
            @if (fromCart)
            {
                <a asp-controller="Cart" asp-action="Index" class="text-secondary text-decoration-none hover-underline">&larr; Back to Cart</a>
            }
            else
            {
                <a asp-controller="Order" asp-action="Details" asp-route-id="@orderId" class="text-secondary text-decoration-none hover-underline">&larr; Back to Order</a>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="pinModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header border-0 bg-gradient text-white rounded-top-4">
                <h5 class="modal-title fw-bold">🔐 Enter Your PIN</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <input type="password" id="pinCode" class="form-control text-center rounded-pill py-2 mb-3" placeholder="Enter 4-digit PIN" maxlength="4" required />
                <p class="text-muted small">For security, please confirm your wallet PIN.</p>
            </div>
            <div class="modal-footer border-0 d-flex justify-content-center">
                <button class="btn btn-success rounded-pill px-4 fw-semibold" onclick="verifyPin()">✅ Confirm</button>
            </div>
        </div>
    </div>
</div>

<style>
    .wallet-payment-container {
        min-height: 80vh;
        background: linear-gradient(135deg, #f9fafb, #f1f5f9);
    }

    .payment-card {
        width: 100%;
        max-width: 520px;
        background: #fff;
        border: none;
        position: relative;
        transition: all 0.3s ease;
    }

        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

    .text-gradient {
        background: linear-gradient(90deg, #ff8a00, #e52e71);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .summary-box {
        background: linear-gradient(145deg, #f0f4f8, #ffffff);
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
    }

    .btn-gradient {
        background: linear-gradient(90deg, #28a745, #20c997);
        border: none;
        color: #fff;
        transition: all 0.3s ease;
    }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(32, 201, 151, 0.3);
        }

    select:focus, input:focus {
        border-color: #20c997;
        box-shadow: 0 0 0 0.2rem rgba(32, 201, 151, 0.25);
        outline: none;
    }

    .hover-underline:hover {
        text-decoration: underline;
    }

    .bg-gradient {
        background: linear-gradient(90deg, #007bff, #6610f2);
    }
</style>

<script>
    function showWalletIdField() {
        const walletType = document.getElementById('walletType').value;
        const walletDiv = document.getElementById('walletIdDiv');
        const walletLabel = document.getElementById('walletIdLabel');
        const walletInput = document.getElementById('walletId');

        if (walletType === "") {
            walletDiv.style.display = "none";
            walletInput.required = false;
        } else {
            walletDiv.style.display = "block";
            walletInput.required = true;
            walletLabel.innerText = walletType + " ID";
            walletInput.placeholder = "Enter your " + walletType + " ID";
        }
    }

    function openPinModal() {
        const walletType = document.getElementById('walletType').value;
        const walletId = document.getElementById('walletId').value;

        if (!walletType || !walletId) {
            alert("Please select a wallet and enter your Wallet ID first!");
            return;
        }
        new bootstrap.Modal(document.getElementById('pinModal')).show();
    }

    function verifyPin() {
        const pin = document.getElementById('pinCode').value;
        if (pin === "1234") {  
            document.getElementById('walletPaymentForm').submit();
        } else {
            alert("❌ Invalid PIN! Please try again.");
        }
    }
</script>
