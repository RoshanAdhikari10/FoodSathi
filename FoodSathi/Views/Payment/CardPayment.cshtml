@{
    ViewData["Title"] = "Card Payment | FoodSathi";
    var orderId = ViewBag.OrderId;
    var amount = ViewBag.Amount;
    var fromCart = ViewBag.FromCart ?? false;
}

<div class="container py-5 fade-in">
    <div class="mx-auto payment-wrapper text-center shadow-lg rounded-5 p-4 p-md-5 position-relative">
        <!-- 🧾 Header -->
        <div class="mb-4">
            <div class="payment-step mb-2 fw-semibold text-muted small">Step 3 of 3 – Payment</div>
            <h2 class="fw-bold text-gradient mb-2">💳 Secure Card Payment</h2>
            <p class="text-secondary mb-0 small">Your payment is protected with SSL encryption.</p>
        </div>

        <!-- 🧾 Order Info -->
        <div class="order-summary bg-light bg-opacity-75 rounded-4 p-3 mb-4 shadow-sm text-start">
            @if (!fromCart)
            {
                <p class="mb-1"><i class="bi bi-receipt-cutoff text-gradient"></i> <strong>Order ID:</strong> #@orderId</p>
            }
            <p class="mb-0"><i class="bi bi-cash-stack text-gradient"></i> <strong>Total Amount:</strong> Rs. @amount</p>
        </div>

        <!-- 💳 Payment Form -->
        <form id="paymentForm" asp-action="@(fromCart ? "PayByCardConfirmFromCart" : "PayByCardConfirm")" method="post" class="text-start">
            @Html.AntiForgeryToken()

            @if (!fromCart)
            {
                <input type="hidden" name="orderId" value="@orderId" />
            }
            else
            {
                <input type="hidden" name="amount" value="@amount" />
            }

            <!-- Card Number -->
            <div class="form-group mb-4">
                <label class="fw-semibold mb-2">Card Number <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-credit-card-2-front text-gradient"></i>
                    </span>
                    <input type="text" id="cardNumber" name="cardNumber"
                           class="form-control border-start-0 shadow-sm focus-glow"
                           placeholder="1234 5678 9012 3456"
                           maxlength="19"
                           pattern="\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}" required />
                </div>
            </div>

            <!-- Expiry & CVV -->
            <div class="row mb-4">
                <div class="col-6">
                    <label class="fw-semibold mb-2">Expiry Date <span class="text-danger">*</span></label>
                    <input type="text" class="form-control text-center shadow-sm focus-glow"
                           name="expiryDate"
                           placeholder="MM/YY"
                           maxlength="5"
                           pattern="^(0[1-9]|1[0-2])\/?([0-9]{2})$"
                           required />
                </div>
                <div class="col-6">
                    <label class="fw-semibold mb-2">CVV <span class="text-danger">*</span></label>
                    <input type="password" class="form-control text-center shadow-sm focus-glow"
                           name="cvv"
                           placeholder="***"
                           maxlength="3"
                           pattern="\d{3}"
                           required />
                </div>
            </div>

            <!-- Cardholder Name -->
            <div class="form-group mb-4">
                <label class="fw-semibold mb-2">Cardholder Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control text-center shadow-sm focus-glow"
                       name="cardholderName"
                       placeholder="Enter name as shown on card"
                       required />
            </div>

            <!-- Pay Button -->
            <button type="submit" id="payButton" class="btn btn-gradient w-100 rounded-pill fw-bold py-2 mt-2 shadow-sm">
                💸 Pay Rs. @amount Securely
            </button>
        </form>

        <!-- Back Link -->
        <div class="mt-4">
            @if (!fromCart)
            {
                <a asp-controller="Order" asp-action="Details" asp-route-id="@orderId"
                   class="text-secondary text-decoration-none hover-underline">
                    ← Back to Order
                </a>
            }
            else
            {
                <a asp-controller="Cart" asp-action="Index"
                   class="text-secondary text-decoration-none hover-underline">
                    ← Back to Cart
                </a>
            }
        </div>

        <!-- ⏳ Processing Overlay -->
        <div id="loadingOverlay" class="loading-overlay d-none">
            <div class="spinner-border text-light" role="status"></div>
            <p class="mt-3 fw-semibold text-light">Processing Payment...</p>
        </div>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success text-center mt-4 shadow-sm">@TempData["Success"]</div>
}

<!-- 🎨 Styles -->
<style>
    .text-gradient {
        background: linear-gradient(135deg, #ff8a00, #e52e71);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .payment-wrapper {
        max-width: 480px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-gradient {
        background: linear-gradient(135deg, #ff8a00, #e52e71);
        border: none;
        color: white;
        transition: 0.3s ease;
    }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 46, 113, 0.4);
        }

    .focus-glow:focus {
        border-color: #e52e71;
        box-shadow: 0 0 10px rgba(229, 46, 113, 0.25);
    }

    .hover-underline:hover {
        text-decoration: underline;
    }

    .fade-in {
        animation: fadeIn 0.7s ease-in-out;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    /* 🔄 Loading Overlay */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.65);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 30px;
        backdrop-filter: blur(3px);
        transition: opacity 0.3s ease;
        z-index: 10;
    }

    .d-none {
        display: none !important;
    }

    input::placeholder {
        color: #bbb !important;
        font-style: italic;
    }

    @@media (max-width: 576px) {
        .payment-wrapper

    {
        padding: 2rem 1.5rem;
        border-radius: 2rem;
    }

    }
</style>

<!-- ⚙️ Script -->
<script>
    document.getElementById('paymentForm').addEventListener('submit', function (e) {
        const button = document.getElementById('payButton');
        const overlay = document.getElementById('loadingOverlay');

        // Disable button to prevent double-clicks
        button.disabled = true;
        button.innerHTML = "⏳ Processing...";

        // Show loading overlay
        overlay.classList.remove('d-none');

        // Optional delay (simulate processing)
        setTimeout(() => {
            this.submit();
        }, 800); // short delay for animation effect
    });
</script>
